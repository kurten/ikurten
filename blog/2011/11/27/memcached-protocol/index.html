
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>memcached protocol - ikurten.com</title>
  <meta name="author" content="Kurten">

  
  <meta name="description" content="Memcached Protocol 2011-11-27 | Comments <!-- google_ad_client = "ca-pub-7721655128098525"; /* Blog Main */ google_ad_slot = "7466725066"; &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ikurten.com/blog/2011/11/27/memcached-protocol">
  <link href="/favicon.ico" rel="icon">
  
  <link href="/assets/bootstrap/css/spacelab.min.css" rel="stylesheet" type="text/css">
  <link href="/assets/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css">
  <link href="/assets/bootstrap/css/custom.css" rel="stylesheet" type="text/css">
  <link href="/assets/font-awesome/css/font-awesome.css" rel="stylesheet" type="text/css">
  
  <link href="/atom.xml" rel="alternate" title="ikurten.com" type="application/atom+xml">
  
  

</head>

<body    data-spy="scroll">

  <div class="container">
    <header class="jumbotron subhead" id="overview">
      
<div class="subscribe">
  <table>
    <tr>
      <td><span>Get Updates: &nbsp;</span></td>
      
	  
      
      <td><a href="/atom.xml" class="btn"><i class="icon-cog"></i> By RSS</a></td>
      
      
    </tr>
  </table>
</div>

<h1 class="title">ikurten.com</h1>

  <p class="lead">85后码农</p>


      <div class="navbar">
  <div class="navbar-inner">
    <div class="container" style="width: auto;">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>
      <div class="nav-collapse">
                <ul class="nav">
          <li><a href="/">Home</a></li>
          <li><a href="/blog/archives">Blog</a></li>
          <!--<li><a href="/projects">Projects</a></li>-->
          <li><a href="/blog/about">About Me</a></li>
        </ul>

        
          <form action="http://google.com/search" method="get" class="navbar-search pull-left">
            <fieldset role="search">
              <input type="hidden" name="q" value="site:ikurten.com" />
              <input type="text" name="q" results="0" placeholder="Search" class="search-query span2" />
            </fieldset>
          </form>
        
        
      </div><!-- /.nav-collapse -->
    </div>
  </div><!-- /navbar-inner -->
</div>

    </header>
    <div id="main">
      <div id="content">
        <div class="row">
  
  <div class="span8">
    
  <header>
    
      <h1 class="entry-title">Memcached Protocol</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-27T05:56:29+08:00" pubdate data-updated="true">2011-11-27</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  
    <div style="float: right; padding-left: 15px; padding-botom: 15px; ">
      <script type="text/javascript"><!--
      google_ad_client = "ca-pub-7721655128098525";
      /* Blog Main */
      google_ad_slot = "7466725066";
      google_ad_width = 336;
      google_ad_height = 280;
      //-->
      </script>
      <script type="text/javascript"
      src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
      </script>
    </div>
  
  
  <div class="entry-content"><p>Protocol</p>

<hr />

<p>Clients of memcached communicate with server through TCP connections.</p>

<p>(A UDP interface is also available; details are below under &#8220;UDP</p>

<p>protocol.&#8221;) A given running memcached server listens on some</p>

<p>(configurable) port; clients connect to that port, send commands to</p>

<p>the server, read responses, and eventually close the connection.</p>

<p>There is no need to send any command to end the session. A client may</p>

<p>just close the connection at any moment it no longer needs it. Note,</p>

<p>however, that clients are encouraged to cache their connections rather</p>

<p>than reopen them every time they need to store or retrieve data.&nbsp; This</p>

<p>is because memcached is especially designed to work very efficiently</p>

<p>with a very large number (many hundreds, more than a thousand if</p>

<p>necessary) of open connections. Caching connections will eliminate the</p>

<p>overhead associated with establishing a TCP connection (the overhead</p>

<p>of preparing for a new connection on the server side is insignificant</p>

<p>compared to this).</p>

<p>There are two kinds of data sent in the memcache protocol: text lines</p>

<p>and unstructured data.&nbsp; Text lines are used for commands from clients</p>

<p>and responses from servers. Unstructured data is sent when a client</p>

<p>wants to store or retrieve data. The server will transmit back</p>

<p>unstructured data in exactly the same way it received it, as a byte</p>

<p>stream. The server doesn&#8217;t care about byte order issues in</p>

<p>unstructured data and isn&#8217;t aware of them. There are no limitations on</p>

<p>characters that may appear in unstructured data; however, the reader</p>

<p>of such data (either a client or a server) will always know, from a</p>

<p>preceding text line, the exact length of the data block being</p>

<p>transmitted.</p>

<p>Text lines are always terminated by \r\n. Unstructured data is <em>also</em></p>

<p>terminated by \r\n, even though \r, \n or any other 8-bit characters</p>

<p>may also appear inside the data. Therefore, when a client retrieves</p>

<p>data from a server, it must use the length of the data block (which it</p>

<p>will be provided with) to determine where the data block ends, and not</p>

<p>the fact that \r\n follows the end of the data block, even though it</p>

<p>does.</p>

<p>Keys</p>

<hr />

<p>Data stored by memcached is identified with the help of a key. A key</p>

<p>is a text string which should uniquely identify the data for clients</p>

<p>that are interested in storing and retrieving it.&nbsp; Currently the</p>

<p>length limit of a key is set at 250 characters (of course, normally</p>

<p>clients wouldn&#8217;t need to use such long keys); the key must not include</p>

<p>control characters or whitespace.</p>

<p>Commands</p>

<hr />

<p>There are three types of commands.</p>

<p>Storage commands (there are six: &#8220;set&#8221;, &#8220;add&#8221;, &#8220;replace&#8221;, &#8220;append&#8221;</p>

<p>&#8220;prepend&#8221; and &#8220;cas&#8221;) ask the server to store some data identified by a key. The</p>

<p>client sends a command line, and then a data block; after that the</p>

<p>client expects one line of response, which will indicate success or</p>

<p>faulure.</p>

<p>Retrieval commands (there are two: &#8220;get&#8221; and &#8220;gets&#8221;) ask the server to</p>

<p>retrieve data corresponding to a set of keys (one or more keys in one</p>

<p>request). The client sends a command line, which includes all the</p>

<p>requested keys; after that for each item the server finds it sends to</p>

<p>the client one response line with information about the item, and one</p>

<p>data block with the item&#8217;s data; this continues until the server</p>

<p>finished with the &#8220;END&#8221; response line.</p>

<p>All other commands don&#8217;t involve unstructured data. In all of them,</p>

<p>the client sends one command line, and expects (depending on the</p>

<p>command) either one line of response, or several lines of response</p>

<p>ending with &#8220;END&#8221; on the last line.</p>

<p>A command line always starts with the name of the command, followed by</p>

<p>parameters (if any) delimited by whitespace. Command names are</p>

<p>lower-case and are case-sensitive.</p>

<p>Expiration times</p>

<hr />

<p>Some commands involve a client sending some kind of expiration time</p>

<p>(relative to an item or to an operation requested by the client) to</p>

<p>the server. In all such cases, the actual value sent may either be</p>

<p>Unix time (number of seconds since January 1, 1970, as a 32-bit</p>

<p>value), or a number of seconds starting from current time. In the</p>

<p>latter case, this number of seconds may not exceed 60<em>60</em>24*30 (number</p>

<p>of seconds in 30 days); if the number sent by a client is larger than</p>

<p>that, the server will consider it to be real Unix time value rather</p>

<p>than an offset from current time.</p>

<p>Error strings</p>

<hr />

<p>Each command sent by a client may be answered with an error string</p>

<p>from the server. These error strings come in three types:</p>

<ul>
<li>&#8220;ERROR\r\n&#8221;</li>
</ul>


<p>means the client sent a nonexistent command name.</p>

<ul>
<li>&#8220;CLIENT_ERROR <error>\r\n&#8221;</li>
</ul>


<p>means some sort of client error in the input line, i.e. the input</p>

<p>doesn&#8217;t conform to the protocol in some way. <error> is a</p>

<p>human-readable error string.</p>

<ul>
<li>&#8220;SERVER_ERROR <error>\r\n&#8221;</li>
</ul>


<p>means some sort of server error prevents the server from carrying</p>

<p>out the command. <error> is a human-readable error string. In cases</p>

<p>of severe server errors, which make it impossible to continue</p>

<p>serving the client (this shouldn&#8217;t normally happen), the server will</p>

<p>close the connection after sending the error line. This is the only</p>

<p>case in which the server closes a connection to a client.</p>

<p>In the descriptions of individual commands below, these error lines</p>

<p>are not again specifically mentioned, but clients must allow for their</p>

<p>possibility.</p>

<p>Storage commands</p>

<hr />

<p>First, the client sends a command line which looks like this:</p>

<p><command name> <key> <flags> <exptime> <bytes> [noreply]\r\n</p>

<p>cas <key> <flags> <exptime> <bytes> <cas unqiue> [noreply]\r\n</p>

<ul>
<li><command name> is &#8220;set&#8221;, &#8220;add&#8221;, &#8220;replace&#8221;, &#8220;append&#8221; or &#8220;prepend&#8221;</li>
</ul>


<p>&#8220;set&#8221; means &#8220;store this data&#8221;.</p>

<p>&#8220;add&#8221; means &#8220;store this data, but only if the server <em>doesn&#8217;t</em> already</p>

<p>hold data for this key&#8221;.</p>

<p>&#8220;replace&#8221; means &#8220;store this data, but only if the server <em>does</em></p>

<p>already hold data for this key&#8221;.</p>

<p>&#8220;append&#8221; means &#8220;add this data to an existing key after existing data&#8221;.</p>

<p>&#8220;prepend&#8221; means &#8220;add this data to an existing key before existing data&#8221;.</p>

<p>The append and prepend commands do not accept flags or exptime.</p>

<p>They update existing data portions, and ignore new flag and exptime</p>

<p>settings.</p>

<p>&#8220;cas&#8221; is a check and set operation which means &#8220;store this data but</p>

<p>only if no one else has updated since I last fetched it.&#8221;</p>

<ul>
<li><p><key> is the key under which the client asks to store the data</p></li>
<li><p><flags> is an arbitrary 16-bit unsigned integer (written out in</p></li>
</ul>


<p>decimal) that the server stores along with the data and sends back</p>

<p>when the item is retrieved. Clients may use this as a bit field to</p>

<p>store data-specific information; this field is opaque to the server.</p>

<p>Note that in memcached 1.2.1 and higher, flags may be 32-bits, instead</p>

<p>of 16, but you might want to restrict yourself to 16 bits for</p>

<p>compatibility with older versions.</p>

<ul>
<li><exptime> is expiration time. If it&#8217;s 0, the item never expires</li>
</ul>


<p>(although it may be deleted from the cache to make place for other</p>

<p>items). If it&#8217;s non-zero (either Unix time or offset in seconds from</p>

<p>current time), it is guaranteed that clients will not be able to</p>

<p>retrieve this item after the expiration time arrives (measured by</p>

<p>server time).</p>

<ul>
<li><bytes> is the number of bytes in the data block to follow, <em>not</em></li>
</ul>


<p>including the delimiting \r\n. <bytes> may be zero (in which case</p>

<p>it&#8217;s followed by an empty data block).</p>

<ul>
<li><cas unique> is a unique 64-bit value of an existing entry.</li>
</ul>


<p>Clients should use the value returned from the &#8220;gets&#8221; command</p>

<p>when issuing &#8220;cas&#8221; updates.</p>

<ul>
<li>&#8220;noreply&#8221; optional parameter instructs the server to not send the</li>
</ul>


<p>reply.&nbsp; NOTE: if the request line is malformed, the server can&#8217;t</p>

<p>parse &#8220;noreply&#8221; option reliably.&nbsp; In this case it may send the error</p>

<p>to the client, and not reading it on the client side will break</p>

<p>things.&nbsp; Client should construct only valid requests.</p>

<p>After this line, the client sends the data block:</p>

<p><data block>\r\n</p>

<ul>
<li><data block> is a chunk of arbitrary 8-bit data of length <bytes></li>
</ul>


<p>from the previous line.</p>

<p>After sending the command line and the data blockm the client awaits</p>

<p>the reply, which may be:</p>

<ul>
<li><p>&#8220;STORED\r\n&#8221;, to indicate success.</p></li>
<li><p>&#8220;NOT_STORED\r\n&#8221; to indicate the data was not stored, but not</p></li>
</ul>


<p>because of an error. This normally means that either that the</p>

<p>condition for an &#8220;add&#8221; or a &#8220;replace&#8221; command wasn&#8217;t met, or that the</p>

<p>item is in a delete queue (see the &#8220;delete&#8221; command below).</p>

<ul>
<li>&#8220;EXISTS\r\n&#8221; to indicate that the item you are trying to store with</li>
</ul>


<p>a &#8220;cas&#8221; command has been modified since you last fetched it.</p>

<ul>
<li>&#8220;NOT_FOUND\r\n&#8221; to indicate that the item you are trying to store</li>
</ul>


<p>with a &#8220;cas&#8221; command did not exist or has been deleted.</p>

<p>Retrieval command:</p>

<hr />

<p>The retrieval commands &#8220;get&#8221; and &#8220;gets&#8221; operates like this:</p>

<p>get <key>*\r\n</p>

<p>gets <key>*\r\n</p>

<ul>
<li><key>* means one or more key strings separated by whitespace.</li>
</ul>


<p>After this command, the client expects zero or more items, each of</p>

<p>which is received as a text line followed by a data block. After all</p>

<p>the items have been transmitted, the server sends the string</p>

<p>&#8220;END\r\n&#8221;</p>

<p>to indicate the end of response.</p>

<p>Each item sent by the server looks like this:</p>

<p>VALUE <key> <flags> <bytes> [<cas unique>]\r\n</p>

<p><data block>\r\n</p>

<ul>
<li><p><key> is the key for the item being sent</p></li>
<li><p><flags> is the flags value set by the storage command</p></li>
<li><p><bytes> is the length of the data block to follow, <em>not</em> including</p></li>
</ul>


<p>its delimiting \r\n</p>

<ul>
<li><cas unique> is a unique 64-bit integer that uniquely identifies</li>
</ul>


<p>this specific item.</p>

<ul>
<li><data block> is the data for this item.</li>
</ul>


<p>If some of the keys appearing in a retrieval request are not sent back</p>

<p>by the server in the item list this means that the server does not</p>

<p>hold items with such keys (because they were never stored, or stored</p>

<p>but deleted to make space for more items, or expired, or explicitly</p>

<p>deleted by a client).</p>

<p>Deletion</p>

<hr />

<p>The command &#8220;delete&#8221; allows for explicit deletion of items:</p>

<p>delete <key> [<time>] [noreply]\r\n</p>

<ul>
<li><p><key> is the key of the item the client wishes the server to delete</p></li>
<li><p><time> is the amount of time in seconds (or Unix time until which)</p></li>
</ul>


<p>the client wishes the server to refuse &#8220;add&#8221; and &#8220;replace&#8221; commands</p>

<p>with this key. For this amount of item, the item is put into a</p>

<p>delete queue, which means that it won&#8217;t possible to retrieve it by</p>

<p>the &#8220;get&#8221; command, but &#8220;add&#8221; and &#8220;replace&#8221; command with this key</p>

<p>will also fail (the &#8220;set&#8221; command will succeed, however). After the</p>

<p>time passes, the item is finally deleted from server memory.</p>

<p>The parameter <time> is optional, and, if absent, defaults to 0</p>

<p>(which means that the item will be deleted immediately and further</p>

<p>storage commands with this key will succeed).</p>

<ul>
<li>&#8220;noreply&#8221; optional parameter instructs the server to not send the</li>
</ul>


<p>reply.&nbsp; See the note in Storage commands regarding malformed</p>

<p>requests.</p>

<p>The response line to this command can be one of:</p>

<ul>
<li><p>&#8220;DELETED\r\n&#8221; to indicate success</p></li>
<li><p>&#8220;NOT_FOUND\r\n&#8221; to indicate that the item with this key was not</p></li>
</ul>


<p>found.</p>

<p>See the &#8220;flush_all&#8221; command below for immediate invalidation</p>

<p>of all existing items.</p>

<p>Increment/Decrement</p>

<hr />

<p>Commands &#8220;incr&#8221; and &#8220;decr&#8221; are used to change data for some item</p>

<p>in-place, incrementing or decrementing it. The data for the item is</p>

<p>treated as decimal representation of a 64-bit unsigned integer. If the</p>

<p>current data value does not conform to such a representation, the</p>

<p>commands behave as if the value were 0. Also, the item must already</p>

<p>exist for incr/decr to work; these commands won&#8217;t pretend that a</p>

<p>non-existent key exists with value 0; instead, they will fail.</p>

<p>The client sends the command line:</p>

<p>incr <key> <value> [noreply]\r\n</p>

<p>or</p>

<p>decr <key> <value> [noreply]\r\n</p>

<ul>
<li><p><key> is the key of the item the client wishes to change</p></li>
<li><p><value> is the amount by which the client wants to increase/decrease</p></li>
</ul>


<p>the item. It is a decimal representation of a 64-bit unsigned integer.</p>

<ul>
<li>&#8220;noreply&#8221; optional parameter instructs the server to not send the</li>
</ul>


<p>reply.&nbsp; See the note in Storage commands regarding malformed</p>

<p>requests.</p>

<p>The response will be one of:</p>

<ul>
<li><p>&#8220;NOT_FOUND\r\n&#8221; to indicate the item with this value was not found</p></li>
<li><p><value>\r\n , where <value> is the new value of the item&#8217;s data,</p></li>
</ul>


<p>after the increment/decrement operation was carried out.</p>

<p>Note that underflow in the &#8220;decr&#8221; command is caught: if a client tries</p>

<p>to decrease the value below 0, the new value will be 0.&nbsp; Overflow in</p>

<p>the &#8220;incr&#8221; command will wrap around the 64 bit mark.</p>

<p>Note also that decrementing a number such that it loses length isn&#8217;t</p>

<p>guaranteed to decrement its returned length.&nbsp; The number MAY be</p>

<p>space-padded at the end, but this is purely an implementation</p>

<p>optimization, so you also shouldn&#8217;t rely on that.</p>

<p>Statistics</p>

<hr />

<p>The command &#8220;stats&#8221; is used to query the server about statistics it</p>

<p>maintains and other internal data. It has two forms. Without</p>

<p>arguments:</p>

<p>stats\r\n</p>

<p>it causes the server to output general-purpose statistics and</p>

<p>settings, documented below.&nbsp; In the other form it has some arguments:</p>

<p>stats <args>\r\n</p>

<p>Depending on <args>, various internal data is sent by the server. The</p>

<p>kinds of arguments and the data sent are not documented in this vesion</p>

<p>of the protocol, and are subject to change for the convenience of</p>

<p>memcache developers.</p>

<p>General-purpose statistics</p>

<hr />

<p>Upon receiving the &#8220;stats&#8221; command without arguments, the server sents</p>

<p>a number of lines which look like this:</p>

<p>STAT <name> <value>\r\n</p>

<p>The server terminates this list with the line</p>

<p>END\r\n</p>

<p>In each line of statistics, <name> is the name of this statistic, and</p>

<p><value> is the data.&nbsp; The following is the list of all names sent in</p>

<p>response to the &#8220;stats&#8221; command, together with the type of the value</p>

<p>sent for this name, and the meaning of the value.</p>

<p>In the type column below, &#8220;32u&#8221; means a 32-bit unsigned integer, &#8220;64u&#8221;</p>

<p>means a 64-bit unsigner integer. &#8216;32u:32u&#8217; means two 32-but unsigned</p>

<p>integers separated by a colon.</p>

<p>Name&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Type &nbsp; &nbsp; Meaning</p>

<hr />

<p>pid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 32u&nbsp; &nbsp; &nbsp; Process id of this server process</p>

<p>uptime&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 32u&nbsp; &nbsp; &nbsp; Number of seconds this server has been running</p>

<p>time&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 32u&nbsp; &nbsp; &nbsp; current UNIX time according to the server</p>

<p>version &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; string &nbsp; Version string of this server</p>

<p>pointer_size&nbsp; &nbsp; &nbsp; 32 &nbsp; &nbsp; &nbsp; Default size of pointers on the host OS</p>

<p>(generally 32 or 64)</p>

<p>rusage_user &nbsp; &nbsp; &nbsp; 32u:32u&nbsp; Accumulated user time for this process</p>

<p>(seconds:microseconds)</p>

<p>rusage_system &nbsp; &nbsp; 32u:32u&nbsp; Accumulated system time for this process</p>

<p>(seconds:microseconds)</p>

<p>curr_items&nbsp; &nbsp; &nbsp; &nbsp; 32u&nbsp; &nbsp; &nbsp; Current number of items stored by the server</p>

<p>total_items &nbsp; &nbsp; &nbsp; 32u&nbsp; &nbsp; &nbsp; Total number of items stored by this server</p>

<p>ever since it started</p>

<p>bytes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64u&nbsp; &nbsp; &nbsp; Current number of bytes used by this server</p>

<p>to store items</p>

<p>curr_connections&nbsp; 32u&nbsp; &nbsp; &nbsp; Number of open connections</p>

<p>total_connections 32u&nbsp; &nbsp; &nbsp; Total number of connections opened since</p>

<p>the server started running</p>

<p>connection_structures 32u&nbsp; Number of connection structures allocated</p>

<p>by the server</p>

<p>cmd_get &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64u&nbsp; &nbsp; &nbsp; Cumulative number of retrieval requests</p>

<p>cmd_set &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64u&nbsp; &nbsp; &nbsp; Cumulative number of storage requests</p>

<p>get_hits&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64u&nbsp; &nbsp; &nbsp; Number of keys that have been requested and</p>

<p>found present</p>

<p>get_misses&nbsp; &nbsp; &nbsp; &nbsp; 64u&nbsp; &nbsp; &nbsp; Number of items that have been requested</p>

<p>and not found</p>

<p>evictions &nbsp; &nbsp; &nbsp; &nbsp; 64u&nbsp; &nbsp; &nbsp; Number of valid items removed from cache</p>

<p>to free memory for new items</p>

<p>bytes_read&nbsp; &nbsp; &nbsp; &nbsp; 64u&nbsp; &nbsp; &nbsp; Total number of bytes read by this server</p>

<p>from network</p>

<p>bytes_written &nbsp; &nbsp; 64u&nbsp; &nbsp; &nbsp; Total number of bytes sent by this server to</p>

<p>network</p>

<p>limit_maxbytes&nbsp; &nbsp; 32u&nbsp; &nbsp; &nbsp; Number of bytes this server is allowed to</p>

<p>use for storage.</p>

<p>threads &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 32u&nbsp; &nbsp; &nbsp; Number of worker threads requested.</p>

<p>(see doc/threads.txt)</p>

<p>Item statistics</p>

<hr />

<p>CAVEAT: This section describes statistics which are subject to change in the</p>

<p>future.</p>

<p>The &#8220;stats&#8221; command with the argument of &#8220;items&#8221; returns information about</p>

<p>item storage per slab class. The data is returned in the format:</p>

<p>STAT items:<slabclass>:<stat> <value>\r\n</p>

<p>The server terminates this list with the line</p>

<p>END\r\n</p>

<p>The slabclass aligns with class ids used by the &#8220;stats slabs&#8221; command. Where</p>

<p>&#8220;stats slabs&#8221; describes size and memory usage, &#8220;stats items&#8221; shows higher</p>

<p>level information.</p>

<p>The following item values are defined as of writing.</p>

<p>Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Meaning</p>

<hr />

<p>number &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Number of items presently stored in this class. Expired</p>

<p>items are not automatically excluded.</p>

<p>age&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Age of the oldest item in the LRU.</p>

<p>evicted&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Number of times an item had to be evicted from the LRU</p>

<p>before it expired.</p>

<p>outofmemory&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Number of times the underlying slab class was unable to</p>

<p>store a new item. This means you are running with -M or</p>

<p>an eviction failed.</p>

<p>Note this will only display information about slabs which exist, so an empty</p>

<p>cache will return an empty set.</p>

<p>Item size statistics</p>

<hr />

<p>CAVEAT: This section describes statistics which are subject to change in the</p>

<p>future.</p>

<p>The &#8220;stats&#8221; command with the argument of &#8220;sizes&#8221; returns information about the</p>

<p>general size and count of all items stored in the cache.</p>

<p>WARNING: This command WILL lock up your cache! It iterates over <em>every item</em></p>

<p>and examines the size. While the operation is fast, if you have many items</p>

<p>you could prevent memcached from serving requests for several seconds.</p>

<p>The data is returned in the following format:</p>

<p><size> <count>\r\n</p>

<p>The server terminates this list with the line</p>

<p>END\r\n</p>

<p>&#8216;size&#8217; is an approximate size of the item, within 32 bytes.</p>

<p>&#8216;count&#8217; is the amount of items that exist within that 32-byte range.</p>

<p>This is essentially a display of all of your items if there was a slab class</p>

<p>for every 32 bytes. You can use this to determine if adjusting the slab growth</p>

<p>factor would save memory overhead. For example: generating more classes in the</p>

<p>lower range could allow items to fit more snugly into their slab classes, if</p>

<p>most of your items are less than 200 bytes in size.</p>

<p>Slab statistics</p>

<hr />

<p>CAVEAT: This section describes statistics which are subject to change in the</p>

<p>future.</p>

<p>The &#8220;stats&#8221; command with the argument of &#8220;slabs&#8221; returns information about</p>

<p>each of the slabs created by memcached during runtime. This includes per-slab</p>

<p>information along with some totals. The data is returned in the format:</p>

<p>STAT <slabclass>:<stat> <value>\r\n</p>

<p>STAT <stat> <value>\r\n</p>

<p>The server terminates this list with the line</p>

<p>END\r\n</p>

<p>Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Meaning</p>

<hr />

<p>chunk_size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; The amount of space each chunk uses. One item will use</p>

<p>one chunk of the appropriate size.</p>

<p>chunks_per_page&nbsp; &nbsp; &nbsp; &nbsp; How many chunks exist within one page. A page by</p>

<p>default is one megabyte in size. Slabs are allocated per</p>

<p>page, then broken into chunks.</p>

<p>total_pages&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Total number of pages allocated to the slab class.</p>

<p>total_chunks &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Total number of chunks allocated to the slab class.</p>

<p>used_chunks&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; How many chunks have been allocated to items.</p>

<p>free_chunks&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Chunks not yet allocated to items, or freed via delete.</p>

<p>free_chunks_end&nbsp; &nbsp; &nbsp; &nbsp; Number of free chunks at the end of the last allocated</p>

<p>page.</p>

<p>active_slabs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Total number of slab classes allocated.</p>

<p>total_malloced &nbsp; &nbsp; &nbsp; &nbsp; Total amount of memory allocated to slab pages.</p>

<p>Other commands</p>

<hr />

<p>&#8220;flush_all&#8221; is a command with an optional numeric argument. It always</p>

<p>succeeds, and the server sends &#8220;OK\r\n&#8221; in response (unless &#8220;noreply&#8221;</p>

<p>is given as the last parameter). Its effect is to invalidate all</p>

<p>existing items immediately (by default) or after the expiration</p>

<p>specified.&nbsp; After invalidation none of the items will be returned in</p>

<p>response to a retrieval command (unless it&#8217;s stored again under the</p>

<p>same key <em>after</em> flush_all has invalidated the items). flush_all</p>

<p>doesn&#8217;t actually free all the memory taken up by existing items; that</p>

<p>will happen gradually as new items are stored. The most precise</p>

<p>definition of what flush_all does is the following: it causes all</p>

<p>items whose update time is earlier than the time at which flush_all</p>

<p>was set to be executed to be ignored for retrieval purposes.</p>

<p>The intent of flush_all with a delay, was that in a setting where you</p>

<p>have a pool of memcached servers, and you need to flush all content,</p>

<p>you have the option of not resetting all memcached servers at the</p>

<p>same time (which could e.g. cause a spike in database load with all</p>

<p>clients suddenly needing to recreate content that would otherwise</p>

<p>have been found in the memcached daemon).</p>

<p>The delay option allows you to have them reset in e.g. 10 second</p>

<p>intervals (by passing 0 to the first, 10 to the second, 20 to the</p>

<p>third, etc. etc.).</p>

<p>&#8220;version&#8221; is a command with no arguments:</p>

<p>version\r\n</p>

<p>In response, the server sends&nbsp;&#8220;VERSION <version>\r\n&#8221;, where <version> is the version string for the</p>

<p>server.</p>

<p>&#8220;verbosity&#8221; is a command with a numeric argument. It always succeeds,</p>

<p>and the server sends &#8220;OK\r\n&#8221; in response (unless &#8220;noreply&#8221; is given</p>

<p>as the last parameter). Its effect is to set the verbosity level of</p>

<p>the logging output.</p>

<p>&#8220;quit&#8221; is a command with no arguments:</p>

<p>quit\r\n</p>

<p>Upon receiving this command, the server closes the</p>

<p>connection. However, the client may also simply close the connection</p>

<p>when it no longer needs it, without issuing this command.</p>

<p>UDP protocol</p>

<hr />

<p>For very large installations where the number of clients is high enough</p>

<p>that the number of TCP connections causes scaling difficulties, there is</p>

<p>also a UDP-based interface. The UDP interface does not provide guaranteed</p>

<p>delivery, so should only be used for operations that aren&#8217;t required to</p>

<p>succeed; typically it is used for &#8220;get&#8221; requests where a missing or</p>

<p>incomplete response can simply be treated as a cache miss.</p>

<p>Each UDP datagram contains a simple frame header, followed by data in the</p>

<p>same format as the TCP protocol described above. In the current</p>

<p>implementation, requests must be contained in a single UDP datagram, but</p>

<p>responses may span several datagrams. (The only common requests that would</p>

<p>span multiple datagrams are huge multi-key &#8220;get&#8221; requests and &#8220;set&#8221;</p>

<p>requests, both of which are more suitable to TCP transport for reliability</p>

<p>reasons anyway.)</p>

<p>The frame header is 8 bytes long, as follows (all values are 16-bit integers</p>

<p>in network byte order, high byte first):</p>

<p>0-1 Request ID</p>

<p>2-3 Sequence number</p>

<p>4-5 Total number of datagrams in this message</p>

<p>6-7 Reserved for future use; must be 0</p>

<p>The request ID is supplied by the client. Typically it will be a</p>

<p>monotonically increasing value starting from a random seed, but the client</p>

<p>is free to use whatever request IDs it likes. The server&#8217;s response will</p>

<p>contain the same ID as the incoming request. The client uses the request ID</p>

<p>to differentiate between responses to outstanding requests if there are</p>

<p>several pending from the same server; any datagrams with an unknown request</p>

<p>ID are probably delayed responses to an earlier request and should be</p>

<p>discarded.</p>

<p>The sequence number ranges from 0 to n-1, where n is the total number of</p>

<p>datagrams in the message. The client should concatenate the payloads of the</p>

<p>datagrams for a given response in sequence number order; the resulting byte</p>

<p>stream will contain a complete response in the same format as the TCP</p>

<p>protocol (including terminating \r\n sequences).</p>
</div>

  
    <script type="text/javascript"><!--
    google_ad_client = "ca-pub-7721655128098525";
    /* Blog Bottom */
    google_ad_slot = "4562123819";
    google_ad_width = 728;
    google_ad_height = 90;
    //-->
    </script>
    <script type="text/javascript"
    src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
    </script>
  


    <footer>
      <p class="meta">
        
  

<span class="byline author vcard">Posted by <span class="fn">Kurten</span></span>

        








  


<time datetime="2011-11-27T05:56:29+08:00" pubdate data-updated="true">2011-11-27</time>
        

<span class="categories">
  
    <a class='category' href='/blog/categories/memcached/'>memcached</a>
  
</span>


      </p>
      
        <div class="sharing">
  <br/>
  
  
  
</div>

      
      <p class="meta">
        
          <a class="basic-alignment pull-left" href="/blog/2011/09/11/911/" title="Previous Post: 911絮叨">&laquo; 911絮叨</a>
        
        
          <a class="basic-alignment pull-right" href="/blog/2011/12/04/memcacheq/" title="Next Post: 阅读memcacheq源码记录">阅读memcacheq源码记录 &raquo;</a>
        
      </p>
    </footer>
    
    
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
      </section>
    
  </div>

  
    
    <div class="span sidebar">
    <div class="well">
      
        <section>
  <h2>Recent Posts</h2>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/01/27/blog-migrate-to-github/">博客迁移</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/14/redis2/">redis源码学习记录(二)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/19/redis1/">redis源码学习记录</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/15/centos-yum-error/">centos中yum无法使用问题</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/04/memcacheq/">阅读memcacheq源码记录</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Links</h1>
  <ul id="recent_posts">
      <li class="post">
        <a href="http://hmfly.info/">GeoVisual(GIS读研南)</a>
      </li>
  </ul>
</section>

<section>
  <h2>GitHub Repos</h2>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/kurten">@kurten</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'kurten',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section>
  <h2>On Delicious</h2>
  <div id="delicious"></div>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/json/kurten?count=3&amp;sort=date&amp;callback=renderDeliciousLinks"></script>
  <p><a href="http://delicious.com/kurten">My Delicious Bookmarks &raquo;</a></p>
</section>




      
    </div>
  </div>



  
</div>


      </div>
    </div>
    <footer class="footer"><p>
  Copyright &copy; 2013 - Kurten -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> -
  <span class="credit">Theme by <a href="https://github.com/barmstrong/octopress-bootstrap">Brian Armstrong</a></span> -
  <span class="credit">Edited by <a href="http://ikurten.com">Kurten</a></span>
</p>
</footer>
    

<script type="text/javascript">
      var disqus_shortname = 'ikurten';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://ikurten.com/blog/2011/11/27/memcached-protocol/';
        var disqus_url = 'http://ikurten.com/blog/2011/11/27/memcached-protocol/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







<script src="/javascripts/jquery.min.js"></script>
<script src="/assets/bootstrap/js/bootstrap.min.js"></script>


  </div>
</body>
</html>
